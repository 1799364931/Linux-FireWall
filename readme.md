# Linux 个人防火墙

## 1 实现功能

### 1.1 安全规则

+ 基于IP的过滤：根据源IP或目标IP地址进行过滤。
+ 基于端口的过滤：针对TCP和UDP，根据源端口或目标端口进行过滤。
+ 基于协议的过滤：根据IP协议类型进行过滤。
+ 基于MAC地址的过滤：根据源MAC或目标MAC地址进行过滤（通常只在局域网内有效）。
+ 基于包状态的过滤（状态防火墙）：例如，只允许已建立连接的数据包通过。
+ 基于数据包内容的过滤（深度包检测）：检查数据包负载中的特定字符串或模式。
+ 基于时间段的过滤：在特定时间段内启用或禁用规则。
+ 基于网络接口的过滤：根据数据包进入或离开的网络接口进行过滤。
+ 流量限制（限速）：限制某个IP或端口的流量速率。
+ 日志记录：对匹配规则的数据包进行日志记录。

## 2 框架设计

### 2.1 安全规则设计
利用`netfilter`库对挂载点进行`hook function`挂载，利用挂载链实现挂载过滤函数复用和逻辑拆分。

#### 2.1.1 PRE_ROUTING
+ IP 过滤
+ 基础协议过滤
+ 流量速率限制

#### 2.1.2 LOCAL_IN
+ 端口访问规则
+ 连接状态管理
+ 应用层协议过滤
+ IP 过滤
+ 基础协议过滤
+ 流量速率限制

### 2.2 安全规则挂载

定义一个规则结构体链表，所有挂载的`hook function`在挂载前都需要对该链表进行遍历，从而获得过滤的规则

IP 端口 协议 MAC

利用skb->cb存储上下文信息，用skb的cb数组存储一个8字节的位图，对每一类规则，比如说源ip，源端口，都赋予一个位图上的位，比如0x1，0x2，当数据包在钩子函数流动的时候，每次如果满足被过滤的规则，就在位图对应位置置1，如果在某一个钩子函数中，该位图和原有的规则位图相等，则说明所有过滤条件满足，丢弃该包。

### 2.3 用户和内核通信


